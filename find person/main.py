precallData = []
precallData.append((0.5, 1.0, 0.412))
precallData.append((0.51, 0.9953596287703016, 0.429))
precallData.append((0.52, 0.9978902953586498, 0.473))
precallData.append((0.53, 0.9940239043824701, 0.499))
precallData.append((0.54, 0.9979166666666667, 0.479))
precallData.append((0.55, 0.9958071278825996, 0.475))
precallData.append((0.56, 0.9980392156862745, 0.509))
precallData.append((0.5700000000000001, 0.994413407821229, 0.534))
precallData.append((0.5800000000000001, 0.9872727272727273, 0.543))
precallData.append((0.5900000000000001, 0.9947916666666666, 0.573))
precallData.append((0.6000000000000001, 0.9982817869415808, 0.581))
precallData.append((0.6100000000000001, 0.9904306220095693, 0.621))
precallData.append((0.6200000000000001, 0.9983361064891847, 0.6))
precallData.append((0.6300000000000001, 0.9931153184165232, 0.577))
precallData.append((0.6400000000000001, 0.9904306220095693, 0.621))
precallData.append((0.6500000000000001, 0.9937597503900156, 0.637))
precallData.append((0.6600000000000001, 0.9954268292682927, 0.653))
precallData.append((0.6700000000000002, 0.9891472868217054, 0.638))
precallData.append((0.6800000000000002, 0.9940029985007496, 0.663))
precallData.append((0.6900000000000002, 0.9925705794947994, 0.668))
precallData.append((0.7000000000000002, 0.990625, 0.634))
precallData.append((0.7100000000000002, 0.9955489614243324, 0.671))
precallData.append((0.7200000000000002, 0.994261119081779, 0.693))
precallData.append((0.7300000000000002, 0.9889196675900277, 0.714))
precallData.append((0.7400000000000002, 0.9891745602165088, 0.731))
precallData.append((0.7500000000000002, 0.9906291834002677, 0.74))
precallData.append((0.7600000000000002, 0.9960526315789474, 0.757))
precallData.append((0.7700000000000002, 0.988110964332893, 0.748))
precallData.append((0.7800000000000002, 0.9920424403183024, 0.748))
precallData.append((0.7900000000000003, 0.9934640522875817, 0.76))
precallData.append((0.8000000000000003, 0.9923857868020305, 0.782))
precallData.append((0.8100000000000003, 0.9936386768447837, 0.781))
precallData.append((0.8200000000000003, 0.9873577749683944, 0.781))
precallData.append((0.8300000000000003, 0.9924812030075187, 0.792))
precallData.append((0.8400000000000003, 0.9889025893958077, 0.802))
precallData.append((0.8500000000000003, 0.9842424242424243, 0.812))
precallData.append((0.8600000000000003, 0.9865525672371638, 0.807))
precallData.append((0.8700000000000003, 0.9857651245551602, 0.831))
precallData.append((0.8800000000000003, 0.9831528279181708, 0.817))
precallData.append((0.8900000000000003, 0.9846335697399528, 0.833))
precallData.append((0.9000000000000004, 0.9879951980792316, 0.823))
precallData.append((0.9100000000000004, 0.9811542991755006, 0.833))
precallData.append((0.9200000000000004, 0.9781859931113662, 0.852))
precallData.append((0.9300000000000004, 0.9840728100113766, 0.865))
precallData.append((0.9400000000000004, 0.9796149490373726, 0.865))
precallData.append((0.9500000000000004, 0.9700996677740864, 0.876))
precallData.append((0.9600000000000004, 0.9719416386083053, 0.866))
precallData.append((0.9700000000000004, 0.9820022497187851, 0.873))
precallData.append((0.9800000000000004, 0.9771689497716894, 0.856))
precallData.append((0.9900000000000004, 0.9758507135016465, 0.889))
precallData.append((1.0000000000000004, 0.9845644983461963, 0.893))
precallData.append((1.0100000000000005, 0.9711111111111111, 0.874))
precallData.append((1.0200000000000005, 0.9718785151856018, 0.864))
precallData.append((1.0300000000000005, 0.9730312837108953, 0.902))
precallData.append((1.0400000000000005, 0.9735973597359736, 0.885))
precallData.append((1.0500000000000005, 0.9792576419213974, 0.897))
precallData.append((1.0600000000000005, 0.9636363636363636, 0.901))
precallData.append((1.0700000000000005, 0.9717391304347827, 0.894))
precallData.append((1.0800000000000005, 0.974025974025974, 0.9))
precallData.append((1.0900000000000005, 0.973404255319149, 0.915))
precallData.append((1.1000000000000005, 0.9661375661375662, 0.913))
precallData.append((1.1100000000000005, 0.9648397104446742, 0.933))
precallData.append((1.1200000000000006, 0.9558823529411765, 0.91))
precallData.append((1.1300000000000006, 0.9684542586750788, 0.921))
precallData.append((1.1400000000000006, 0.9610115911485775, 0.912))
precallData.append((1.1500000000000006, 0.9552083333333333, 0.917))
precallData.append((1.1600000000000006, 0.9631901840490797, 0.942))
precallData.append((1.1700000000000006, 0.971875, 0.933))
precallData.append((1.1800000000000006, 0.9579487179487179, 0.934))
precallData.append((1.1900000000000006, 0.956745623069001, 0.929))
precallData.append((1.2000000000000006, 0.9569672131147541, 0.934))
precallData.append((1.2100000000000006, 0.9585439838220424, 0.948))
precallData.append((1.2200000000000006, 0.9552390640895219, 0.939))
precallData.append((1.2300000000000006, 0.9481555333998006, 0.951))
precallData.append((1.2400000000000007, 0.9616161616161616, 0.952))
precallData.append((1.2500000000000007, 0.953204476093591, 0.937))
precallData.append((1.2600000000000007, 0.9546827794561934, 0.948))
precallData.append((1.2700000000000007, 0.9435643564356435, 0.953))
precallData.append((1.2800000000000007, 0.967032967032967, 0.968))
precallData.append((1.2900000000000007, 0.9515810276679841, 0.963))
precallData.append((1.3000000000000007, 0.9460255152109912, 0.964))
precallData.append((1.3100000000000007, 0.9364613880742912, 0.958))
precallData.append((1.3200000000000007, 0.9333986287952988, 0.953))
precallData.append((1.3300000000000007, 0.9536489151873767, 0.967))
precallData.append((1.3400000000000007, 0.9493545183714002, 0.956))
precallData.append((1.3500000000000008, 0.9475766567754699, 0.958))
precallData.append((1.3600000000000008, 0.9391304347826087, 0.972))
precallData.append((1.3700000000000008, 0.9348034515819751, 0.975))
precallData.append((1.3800000000000008, 0.937984496124031, 0.968))
precallData.append((1.3900000000000008, 0.9454191033138402, 0.97))
precallData.append((1.4000000000000008, 0.9368932038834952, 0.965))
precallData.append((1.4100000000000008, 0.9230038022813688, 0.971))
precallData.append((1.4200000000000008, 0.9296577946768061, 0.978))
precallData.append((1.4300000000000008, 0.9409486931268151, 0.972))
precallData.append((1.4400000000000008, 0.9322519083969466, 0.977))
precallData.append((1.4500000000000008, 0.9209039548022598, 0.978))
precallData.append((1.4600000000000009, 0.9326275264677575, 0.969))
precallData.append((1.4700000000000009, 0.9169811320754717, 0.972))
precallData.append((1.4800000000000009, 0.9131652661064426, 0.978))
precallData.append((1.4900000000000009, 0.9130028063610851, 0.976))
precallData.append((1.5000000000000009, 0.9227144203581527, 0.979))
precallData.append((1.510000000000001, 0.9167446211412535, 0.98))
precallData.append((1.520000000000001, 0.9206798866855525, 0.975))
precallData.append((1.530000000000001, 0.9094304388422035, 0.974))
precallData.append((1.540000000000001, 0.9167446211412535, 0.98))
precallData.append((1.550000000000001, 0.911275415896488, 0.986))
precallData.append((1.560000000000001, 0.9084967320261438, 0.973))
precallData.append((1.570000000000001, 0.9217719132893497, 0.978))
precallData.append((1.580000000000001, 0.9208566108007449, 0.989))
precallData.append((1.590000000000001, 0.9081632653061225, 0.979))
precallData.append((1.600000000000001, 0.9146567717996289, 0.986))
precallData.append((1.610000000000001, 0.9108818011257036, 0.971))
precallData.append((1.620000000000001, 0.8975521305530372, 0.99))
precallData.append((1.630000000000001, 0.9055555555555556, 0.978))
precallData.append((1.640000000000001, 0.9144186046511628, 0.983))
precallData.append((1.650000000000001, 0.8918918918918919, 0.99))
precallData.append((1.660000000000001, 0.9024839006439742, 0.981))
precallData.append((1.670000000000001, 0.8794964028776978, 0.978))
precallData.append((1.680000000000001, 0.8899909828674482, 0.987))
precallData.append((1.690000000000001, 0.8910891089108911, 0.99))
precallData.append((1.700000000000001, 0.8968325791855204, 0.991))
precallData.append((1.710000000000001, 0.8729037952338923, 0.989))
precallData.append((1.720000000000001, 0.8989071038251366, 0.987))
precallData.append((1.730000000000001, 0.8839285714285714, 0.99))
precallData.append((1.740000000000001, 0.8991750687442713, 0.981))
precallData.append((1.750000000000001, 0.8858939802336029, 0.986))
precallData.append((1.7600000000000011, 0.8842386464826358, 0.993))
precallData.append((1.7700000000000011, 0.879646017699115, 0.994))
precallData.append((1.7800000000000011, 0.8711385701676964, 0.987))
precallData.append((1.7900000000000011, 0.8762157382847038, 0.991))
precallData.append((1.8000000000000012, 0.8756613756613757, 0.993))
precallData.append((1.8100000000000012, 0.8640350877192983, 0.985))
precallData.append((1.8200000000000012, 0.8614982578397212, 0.989))
precallData.append((1.8300000000000012, 0.868122270742358, 0.994))
precallData.append((1.8400000000000012, 0.8670166229221348, 0.991))
precallData.append((1.8500000000000012, 0.8648648648648649, 0.992))
precallData.append((1.8600000000000012, 0.8629661751951431, 0.995))
precallData.append((1.8700000000000012, 0.8691834942932397, 0.99))
precallData.append((1.8800000000000012, 0.8608470181503889, 0.996))
precallData.append((1.8900000000000012, 0.8589965397923875, 0.993))
precallData.append((1.9000000000000012, 0.8501291989664083, 0.987))
precallData.append((1.9100000000000013, 0.8471391972672929, 0.992))
precallData.append((1.9200000000000013, 0.8619499568593615, 0.999))
precallData.append((1.9300000000000013, 0.8543273350471294, 0.997))
precallData.append((1.9400000000000013, 0.8500428449014568, 0.992))
precallData.append((1.9500000000000013, 0.837951301427372, 0.998))
precallData.append((1.9600000000000013, 0.8521066208082545, 0.991))
precallData.append((1.9700000000000013, 0.8548109965635738, 0.995))
precallData.append((1.9800000000000013, 0.8427726120033813, 0.997))
precallData.append((1.9900000000000013, 0.8343096234309624, 0.997))
precallData.append((2.0000000000000013, 0.851027397260274, 0.994))
precallData.append((2.0100000000000016, 0.8426395939086294, 0.996))
precallData.append((2.0200000000000014, 0.836272040302267, 0.996))
precallData.append((2.030000000000001, 0.8534704370179949, 0.996))
precallData.append((2.0400000000000014, 0.8242574257425742, 0.999))
precallData.append((2.0500000000000016, 0.8181818181818182, 0.999))
precallData.append((2.0600000000000014, 0.827930174563591, 0.996))
precallData.append((2.070000000000001, 0.8205761316872427, 0.997))
precallData.append((2.0800000000000014, 0.8251864125932062, 0.996))
precallData.append((2.0900000000000016, 0.8309741881765196, 0.998))
precallData.append((2.1000000000000014, 0.8383838383838383, 0.996))
precallData.append((2.110000000000001, 0.8275290215588723, 0.998))
precallData.append((2.1200000000000014, 0.8199013157894737, 0.997))
precallData.append((2.1300000000000017, 0.8234323432343235, 0.998))
precallData.append((2.1400000000000015, 0.8213991769547325, 0.998))
precallData.append((2.1500000000000012, 0.8163934426229508, 0.996))
precallData.append((2.1600000000000015, 0.808130081300813, 0.994))
precallData.append((2.1700000000000017, 0.8110300081103001, 1.0))
precallData.append((2.1800000000000015, 0.8069748580697486, 0.995))
precallData.append((2.1900000000000013, 0.8006430868167203, 0.996))
precallData.append((2.2000000000000015, 0.7966373098478783, 0.995))
precallData.append((2.2100000000000017, 0.8127035830618893, 0.998))
precallData.append((2.2200000000000015, 0.7889328063241107, 0.998))
precallData.append((2.2300000000000013, 0.819078947368421, 0.996))
precallData.append((2.2400000000000015, 0.7923930269413629, 1.0))
precallData.append((2.2500000000000018, 0.8112286411716843, 0.997))
precallData.append((2.2600000000000016, 0.7849293563579278, 1.0))
precallData.append((2.2700000000000014, 0.8048387096774193, 0.998))
precallData.append((2.2800000000000016, 0.7947494033412887, 0.999))
precallData.append((2.290000000000002, 0.79585326953748, 0.998))
precallData.append((2.3000000000000016, 0.8092532467532467, 0.997))
precallData.append((2.3100000000000014, 0.7953821656050956, 0.999))
precallData.append((2.3200000000000016, 0.783359497645212, 0.998))
precallData.append((2.330000000000002, 0.7815191855912295, 0.998))
precallData.append((2.3400000000000016, 0.785377358490566, 0.999))
precallData.append((2.3500000000000014, 0.7925278219395866, 0.997))
precallData.append((2.3600000000000017, 0.7922283901665345, 0.999))
precallData.append((2.370000000000002, 0.7778643803585347, 0.998))
precallData.append((2.3800000000000017, 0.76905311778291, 0.999))
precallData.append((2.3900000000000015, 0.7872340425531915, 0.999))
precallData.append((2.4000000000000017, 0.7768273716951789, 0.999))
precallData.append((2.410000000000002, 0.7782982045277127, 0.997))
precallData.append((2.4200000000000017, 0.7772585669781932, 0.998))
precallData.append((2.4300000000000015, 0.7624140565317036, 0.998))
precallData.append((2.4400000000000017, 0.7638036809815951, 0.996))
precallData.append((2.450000000000002, 0.7637614678899083, 0.999))
precallData.append((2.4600000000000017, 0.7706563706563706, 0.998))
precallData.append((2.4700000000000015, 0.7686969930609098, 0.997))
precallData.append((2.4800000000000018, 0.7641653905053599, 0.998))
precallData.append((2.490000000000002, 0.7593014426727411, 1.0))
precallData.append((2.5000000000000018, 0.7405485544848036, 0.999))
precallData.append((2.5100000000000016, 0.764345830145371, 0.999))
precallData.append((2.520000000000002, 0.7620137299771167, 0.999))
precallData.append((2.530000000000002, 0.7562452687358062, 0.999))
precallData.append((2.540000000000002, 0.744220730797912, 0.998))
precallData.append((2.5500000000000016, 0.74090571640683, 0.998))
precallData.append((2.560000000000002, 0.764345830145371, 0.999))



from dataloader import loadIdentities, gen
from train import generateTripletsDumb, train
from network import NN
import torch.optim as optim
import torch 
import cv2
import torchvision.transforms as transforms
import random

from findIdentity import findIdendityOptimized, smoothRemoveNonPeople, smoothCluster




device = "cuda"
#device = "cpu"

#dataset = loadIdentities(cnt = 5696 - 5650 * 1, H = 150, W = 150, verbose = True) 
dataset = []
model = NN.loadModel().to(device)
learningRate = 1e-4
optimizer = optim.Adam(model.parameters(), lr = learningRate)
margin = 0.2


def printParameters(model):
    sol = 0
    for parameter in model.parameters():
        prod = 1
        for x in parameter.shape:
            prod *= x
        sol += prod
        
        print(parameter.shape, prod)
    print("total params =", sol)

printParameters(model) # 2838080 params

def test(threshold, cntTriplets, repeat, verbose = False):
    TP, FP, TN, FN = 0, 0, 0, 0

    #print("salut boss")

    for i in range(repeat):
        # generate triplets
        triplets = generateTripletsDumb(dataset, cntTriplets, device)
        X = torch.cat(triplets).to(device)

        del triplets
        #torch.cuda.empty_cache() 
        Y = model(X)

        for index in range(cntTriplets):
            a = Y[3 * index]
            b = Y[3 * index + 1]
            c = Y[3 * index + 2]

        
            distAB = ((a - b)**2).sum()
            distAC = ((a - c)**2).sum()

            # positive = sunt la fel pozele
            # negative = nu sunt la fel pozele

            '''
            
            TP = sunt la fel si am zis ca sunt la fel
            TN = nu sunt la fel si am zis ca nu sunt la fel


            FP = nu sunt la fel si am zis ca sunt la fel
            FN = sunt la fel si am zis ca nu sunt la fel

            '''


            if distAB <= threshold:
                TP += 1
            else:
                FN += 1
            
            if distAC <= threshold:
                FP += 1
            else:
                TN += 1
                
            del a 
            del b
            del c
            #torch.cuda.empty_cache() 

        
        del X
        del Y
        #torch.cuda.empty_cache() 

    precision = TP / (TP + FP)
    recall = TP / (TP + FN)
    f1 = 2 / (1 / precision + 1 / recall)

    if verbose == True:
        print(threshold, ":", "precision =", precision, "| recall =", recall, "| f1 score =", f1)
    print("precallData.append((" + str(threshold) + ", " + str(precision) + str(", ") + str(recall) + "))")
    return precision, recall

def draw(cnt):
    import matplotlib.pyplot as plt
    plt.style.use('seaborn-whitegrid')
    import numpy as np
    
    xs = []
    ys = []

    for th in np.arange(0, 5, 0.01):
        x, y = test(th, 1, repeat = 100, verbose = True)
        xs.append(x)
        ys.append(y)

    plt.plot(xs, ys, '.', color = 'black')
    plt.show()

    exit(0)

'''

search(big img, small img, model, precision)

vector of scales = [1, x, 1/x, ... xmax = 2 sau 4] ca parametru 

stride = procent al lui (small img rescaled) 10% of height | stride parametru in search





'''


def sameImg(img1, img2, threshold):


    transform = transforms.Compose([transforms.ToTensor(), transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))]) # (x - mean) / std  

    kek1, img1 = gen(img1)
    kek2, img2 = gen(img2)

    assert kek1 == True
    assert kek2 == True

    img1 = transform(cv2.resize(img1, (150, 150))).unsqueeze(0).to(device)
    img2 = transform(cv2.resize(img2, (150, 150))).unsqueeze(0).to(device)

    A = model(img1)
    B = model(img2)

    distAB = ((A - B)**2).sum()
    return distAB <= threshold

def trainTest():
    print(sameImg(cv2.imread("testData/eu1.jpg"), cv2.imread("testData/eu2.jpg"), 1.25))
    print(sameImg(cv2.imread("testData/eu1.jpg"), cv2.imread("testData/medi1.jpg"), 1.25))
    print(sameImg(cv2.imread("testData/eu1.jpg"), cv2.imread("testData/medi2.jpg"), 1.25))



def testFindIdendity():
    img1 = cv2.imread("obama.jpg", cv2.IMREAD_COLOR)
    img2 = cv2.imread("many.jpg", cv2.IMREAD_COLOR)

    img1 = cv2.resize(img1, fx = 0.5, fy = 0.5, dsize = (0, 0))
    img2 = cv2.resize(img2, fx = 0.5, fy = 0.5, dsize = (0, 0))

    print(img1.shape, img2.shape)

    kek1, img1 = gen(img1)
    assert kek1


    img1 = cv2.resize(img1, (150, 150))
    '''cv2.imshow("kek", img1)

    cv2.imshow("kek2", img2)
    cv2.waitKey(0)
    exit(0)'''
    #img1 = cv2.resize(img1, (150, 150))

    #findIdendity(img2, img1, model, device)

    rects = findIdendityOptimized(bigImg = img2,   # poza in care caut
        identity = img1, # o poza cu persoana pe care o caut
        model = model,   # modelul pe care il folosesc
        transform = transforms.Compose([transforms.ToTensor(), transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))]), # transformarea pe care o face modelul meu pozei
        scales = [1], # la ce raport (in functie de poza mica) sa caut in poza mare
        device = device, # pe ce device vreau sa ruleze
        dim = 150,       # dimensiunea modelului (modelul meu ia poze de dimensiunea 150 * 150)
        strideFactor = 0.1, # ce raport din dimensiunea lui identity are stride-ul
        precisionRecallData = precallData, # informatii despre model in formatul (threshold, precision, recall)
        precision = 0.99, # precizia (el va alege threshold-ul in functie de ea si precisionRecallData)
        maxReturn = None,  # in general e None, dar pot specifica nr maxim de lucruri pe care vreau sa le returnez
        KmeansK = None) # la fiecare size k de la K means, None ca nu fac k means deloc
    
    
    #print(len(rects))
    #rects = smoothRemoveNonPeople(rects, img2)
    #print(len(rects))

    for i in range(len(rects)):
        pr, x1, y1, x2, y2 = rects[i]
        cv2.imshow("kek" + str(pr) + "," + str(i), img2[x1 : x2, y1 : y2])   

    cv2.waitKey(0)              
    exit(0) 

testFindIdendity()

train(model = model, dataset = dataset, epochs = 1000000, optimizer = optimizer, margin = margin, device = device, cntTriplets = 50, repeat = 1)
 